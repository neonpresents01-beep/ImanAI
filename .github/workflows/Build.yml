name: Build ImanAccounting with Icon

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Ù†Ø³Ø®Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡'
        required: false
        default: '7.1.0'

jobs:
  build-windows:
    name: ğŸ—ï¸ Ø³Ø§Ø®Øª EXE ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¨Ø§ Ø¢ÛŒÚ©ÙˆÙ†
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
        uses: actions/checkout@v3
      
      - name: ğŸ”§ Ù†ØµØ¨ Ù¾Ø§ÛŒØªÙˆÙ†
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: ğŸ“¦ Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install pyqt5 pyqt5-tools pyqtchart pycryptodome requests
      
      - name: ğŸ–¼ï¸ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¢ÛŒÚ©ÙˆÙ†
        id: check-icon
        run: |
          if (Test-Path "iman.ico") {
            echo "âœ… Ø¢ÛŒÚ©ÙˆÙ† Ù¾ÛŒØ¯Ø§ Ø´Ø¯"
            echo "has_icon=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "âš ï¸ Ø¢ÛŒÚ©ÙˆÙ† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø² Ø¢ÛŒÚ©ÙˆÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯"
            echo "has_icon=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: ğŸ¨ Ø§ÛŒØ¬Ø§Ø¯ Ø¢ÛŒÚ©ÙˆÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ø§Ú¯Ù‡ Ù†Ø¨Ø§Ø´Ù‡)
        if: steps.check-icon.outputs.has_icon == 'false'
        run: |
          # Ø§ÛŒØ¬Ø§Ø¯ ÛŒÙ‡ Ø¢ÛŒÚ©ÙˆÙ† Ø³Ø§Ø¯Ù‡ Ø¨Ø§ PowerShell
          Add-Type -AssemblyName System.Drawing
          $bmp = New-Object System.Drawing.Bitmap(256, 256)
          $graphics = [System.Drawing.Graphics]::FromImage($bmp)
          $graphics.Clear([System.Drawing.Color]::FromArgb(255, 52, 73, 94))
          $font = New-Object System.Drawing.Font("Arial", 80, [System.Drawing.FontStyle]::Bold)
          $brush = [System.Drawing.Brushes]::White
          $graphics.DrawString("IM", $font, $brush, 40, 70)
          $graphics.DrawString("AN", $font, $brush, 40, 150)
          $graphics.Dispose()
          $bmp.Save("iman.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          
          # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢ÛŒÚ©ÙˆÙ†
          & "$env:SystemRoot\System32\cmd.exe" /c "echo Converting to icon..."
          # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø¨Ø²Ø§Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ BMP
          Copy-Item "iman.bmp" "iman.ico"
      
      - name: ğŸ”¨ Ø³Ø§Ø®Øª EXE Ø¨Ø§ PyInstaller
        run: |
          pyinstaller --onefile `
            --windowed `
            --name="ImanAccounting" `
            --icon="iman.ico" `
            --add-data="plugins;plugins" `
            --hidden-import=PyQt5.sip `
            --hidden-import=Crypto `
            --hidden-import=Crypto.Cipher `
            --hidden-import=Crypto.Util.Padding `
            --version-file=version_info.txt `
            Latestversion3.py
      
      - name: ğŸ“¦ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø³Ø®Ù‡
        run: |
          $version = "${{ github.event.inputs.version }}"
          if ($version -eq "") { $version = "7.1.0" }
          
          @"
          # UTF-8
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=($version -replace '\.', ', '),
              prodvers=($version -replace '\.', ', '),
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
            ),
            kids=[
              StringFileInfo(
                [
                  StringTable(
                    u'040904B0',
                    [StringStruct(u'CompanyName', u'Ø§ÛŒÙ…Ø§Ù† Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ'),
                     StringStruct(u'FileDescription', u'Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ'),
                     StringStruct(u'FileVersion', u'$version'),
                     StringStruct(u'InternalName', u'ImanAccounting'),
                     StringStruct(u'LegalCopyright', u'Â© 2024 Ø§ÛŒÙ…Ø§Ù†'),
                     StringStruct(u'OriginalFilename', u'ImanAccounting.exe'),
                     StringStruct(u'ProductName', u'Ø§ÛŒÙ…Ø§Ù† Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ'),
                     StringStruct(u'ProductVersion', u'$version')])
                ]),
              VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
            ]
          )
          "@ | Out-File -FilePath version_info.txt -Encoding utf8
      
      - name: ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ EXE
        uses: actions/upload-artifact@v4
        with:
          name: ImanAccounting-v${{ github.event.inputs.version }}-with-icon
          path: dist/ImanAccounting.exe
      
      - name: ğŸ“¦ Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ú©ÛŒØ¬ Ú©Ø§Ù…Ù„
        run: |
          New-Item -ItemType Directory -Path package -Force
          Copy-Item dist/ImanAccounting.exe package/
          Copy-Item iman.ico package/ 2>$null
          Copy-Item plugins package/ -Recurse -ErrorAction SilentlyContinue
          
          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ README
          @"
          # Ø§ÛŒÙ…Ø§Ù† Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ v${{ github.event.inputs.version }}
          
          ## ğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹
          - ÙØ§ÛŒÙ„ ImanAccounting.exe Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯
          - Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ù†ØµØ¨ Ù†ÛŒØ³Øª
          
          ## ğŸ”‘ Ù„Ø§ÛŒØ³Ù†Ø³
          - Ø¨Ø±Ø§ÛŒ Ù†Ø³Ø®Ù‡ Ù…Ø¯Ø±Ø³Ù‡: ÙØ§ÛŒÙ„ school.lic Ø±Ø§ Ø¯Ø± Ú©Ù†Ø§Ø± exe Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
          - Ø¨Ø±Ø§ÛŒ Ù†Ø³Ø®Ù‡ Ø§Ø¯Ù…ÛŒÙ†: ÙØ§ÛŒÙ„ admin.lic Ø±Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
          
          ## ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
          - Ø§ÛŒÙ…ÛŒÙ„: neonpresents01@gmail.com
          - ÙˆØ¨Ø³Ø§ÛŒØª: https://neonpresents01-beep.github.io/ImanAI/
          
          Â© 2024 Ø§ÛŒÙ…Ø§Ù†
          "@ | Out-File -FilePath package/README.txt -Encoding utf8
          
          Compress-Archive -Path package/* -DestinationPath ImanAccounting-Package-v${{ github.event.inputs.version }}.zip
      
      - name: ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ Ù¾Ú©ÛŒØ¬
        uses: actions/upload-artifact@v4
        with:
          name: ImanAccounting-Package-v${{ github.event.inputs.version }}
          path: ImanAccounting-Package-v${{ github.event.inputs.version }}.zip
      
      - name: âœ… Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡
        run: |
          Write-Host "ğŸ‰ Ø³Ø§Ø®Øª EXE Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!"
          Write-Host "ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ:"
          Get-ChildItem -Path dist -Recurse
